{% extends "base.html" %}

{% block title %}Credentials Beheer{% endblock %}

{% block content %}
<div class="section">
    <h2>üîê Credentials Beheer</h2>
    <p style="color: #666; margin-bottom: 20px;">Beheer je inloggegevens voor alle services. Klik op een service om credentials in te voeren of te bewerken.</p>
    <div class="buttons-grid">
        <button class="btn btn-add" onclick="openCredentialsModal('smartschool')">
            ‚öôÔ∏è Smartschool
        </button>
        <button class="btn btn-add" onclick="openCredentialsModal('smartschool_admin')">
            ‚öôÔ∏è Smartschool Beheerder
        </button>
        <button class="btn btn-add" onclick="openCredentialsModal('microsoft_admin')">
            ‚öôÔ∏è Microsoft Admin
        </button>
        <button class="btn btn-add" onclick="openCredentialsModal('google_admin')">
            ‚öôÔ∏è Google Admin
        </button>
        <button class="btn btn-add" onclick="openCredentialsModal('easy4u')">
            ‚öôÔ∏è Easy4U
        </button>
    </div>
</div>
{% endblock %}

{% block modals %}
<div id="credentialsModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="credentials-modal-title">Credentials</h3>
            <span class="close" onclick="closeCredentialsModal()">&times;</span>
        </div>
        <div id="credentials-alert-container"></div>
        <form id="credentials-form" onsubmit="saveCredentials(event)">
            <div id="credentials-form-content">
                <!-- Dynamisch ingevuld -->
            </div>
            <button type="submit" class="btn btn-add" style="width: 100%;">
                üíæ Opslaan
            </button>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    const credentialsConfig = {
        smartschool: {
            title: 'Smartschool Credentials',
            fields: [
                { id: 'username', label: 'Gebruikersnaam', type: 'text', required: true, placeholder: 'bijv. voornaam.naam' },
                { id: 'password', label: 'Wachtwoord', type: 'password', required: true, placeholder: 'Je wachtwoord' }
            ]
        },
        smartschool_admin: {
            title: 'Smartschool Beheerder Credentials',
            fields: [
                { id: 'username', label: 'Gebruikersnaam (beheerder)', type: 'text', required: true, placeholder: 'bijv. beheerder.naam' },
                { id: 'password', label: 'Wachtwoord', type: 'password', required: true, placeholder: 'Je wachtwoord' }
            ]
        },
        microsoft_admin: {
            title: 'Microsoft Admin Credentials',
            fields: [
                { id: 'url', label: 'URL', type: 'text', required: true, default: 'https://admin.microsoft.com', placeholder: 'https://admin.microsoft.com' },
                { id: 'email', label: 'E-mail', type: 'email', required: true, placeholder: 'bijv. admin@example.com' },
                { id: 'password', label: 'Wachtwoord', type: 'password', required: true, placeholder: 'Je wachtwoord' }
            ]
        },
        google_admin: {
            title: 'Google Admin Credentials',
            fields: [
                { id: 'url', label: 'URL', type: 'text', required: true, default: 'https://admin.google.com', placeholder: 'https://admin.google.com' },
                { id: 'email', label: 'E-mail', type: 'email', required: true, placeholder: 'bijv. admin@example.com' },
                { id: 'password', label: 'Wachtwoord', type: 'password', required: true, placeholder: 'Je wachtwoord' }
            ]
        },
        easy4u: {
            title: 'Easy4U Credentials',
            fields: [
                { id: 'url', label: 'URL', type: 'text', required: true, default: 'https://easy4u.nl/admin/', placeholder: 'https://easy4u.nl/admin/' },
                { id: 'email', label: 'E-mail', type: 'email', required: true, placeholder: 'bijv. gebruiker@example.com' },
                { id: 'password', label: 'Wachtwoord', type: 'password', required: true, placeholder: 'Je wachtwoord' }
            ]
        }
    };

    let currentCredentialsService = null;

    function showCredentialsAlert(message, type) {
        const container = document.getElementById('credentials-alert-container');
        container.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
        const alert = container.querySelector('.alert');
        alert.style.display = 'block';
        setTimeout(() => {
            alert.style.display = 'none';
        }, 5000);
    }

    async function openCredentialsModal(service) {
        currentCredentialsService = service;
        const config = credentialsConfig[service];
        if (!config) return;

        document.getElementById('credentials-modal-title').textContent = config.title;
        const formContent = document.getElementById('credentials-form-content');
        
        let existingCreds = {};
        try {
            let data;
            
            // Debug: check beschikbaarheid
            console.debug('Loading credentials, appApi available:', !!window.appApi);
            console.debug('pywebview available:', typeof window.pywebview !== 'undefined');
            
            // Probeer eerst via window.appApi (pywebview API)
            if (window.appApi && typeof window.appApi.getCredentials === 'function') {
                try {
                    console.debug('Using appApi.getCredentials()');
                    data = await window.appApi.getCredentials();
                } catch (apiError) {
                    console.warn('API call failed, falling back to fetch:', apiError);
                    // Fallback naar fetch als API faalt
                    const response = await fetch('/api/credentials');
                    data = await response.json();
                }
            } else {
                // Geen API beschikbaar, gebruik direct fetch
                console.debug('Using fetch fallback for getCredentials');
                const response = await fetch('/api/credentials');
                data = await response.json();
            }
            
            if (data && data.success && data.credentials && data.credentials[service]) {
                existingCreds = data.credentials[service];
            }
        } catch (error) {
            console.error('Fout bij laden credentials:', error);
        }

        const getExistingCredentialValue = (fieldId, creds) => {
            if (fieldId === 'username') {
                return creds.username || creds.email || '';
            }
            return creds[fieldId] || '';
        };

        formContent.innerHTML = config.fields.map(field => `
            <div class="form-group">
                <label for="cred-${field.id}">${field.label}${field.required ? ' *' : ''}:</label>
                <input 
                    type="${field.type}" 
                    id="cred-${field.id}" 
                    name="${field.id}"
                    value="${escapeHtml(getExistingCredentialValue(field.id, existingCreds) || field.default || '')}"
                    placeholder="${escapeHtml(field.placeholder || '')}"
                    ${field.required ? 'required' : ''}
                >
            </div>
        `).join('');

        document.getElementById('credentialsModal').style.display = 'block';
        document.getElementById('credentials-alert-container').innerHTML = '';
    }

    function closeCredentialsModal() {
        document.getElementById('credentialsModal').style.display = 'none';
        document.getElementById('credentials-form').reset();
        currentCredentialsService = null;
    }

    async function saveCredentials(event) {
        event.preventDefault();
        if (!currentCredentialsService) return;

        const formData = new FormData(event.target);
        const credentials = {};
        
        credentialsConfig[currentCredentialsService].fields.forEach(field => {
            const value = formData.get(field.id);
            if (value) {
                credentials[field.id] = value.trim();
            }
        });

        try {
            let data;
            
            // Debug: check beschikbaarheid
            console.debug('Saving credentials, appApi available:', !!window.appApi);
            console.debug('saveCredentials function available:', window.appApi && typeof window.appApi.saveCredentials === 'function');
            console.debug('pywebview available:', typeof window.pywebview !== 'undefined');
            
            // Probeer eerst via window.appApi (pywebview API)
            if (window.appApi && typeof window.appApi.saveCredentials === 'function') {
                try {
                    console.debug('Using appApi.saveCredentials()');
                    data = await window.appApi.saveCredentials(currentCredentialsService, credentials);
                } catch (apiError) {
                    console.warn('API call failed, falling back to fetch:', apiError);
                    console.error('API error details:', apiError);
                    // Fallback naar fetch als API faalt
                    console.debug('Using fetch fallback for saveCredentials');
                    const response = await fetch(`/api/credentials/${currentCredentialsService}`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(credentials)
                    });
                    data = await response.json();
                }
            } else {
                // Geen API beschikbaar, gebruik direct fetch
                console.debug('Using fetch fallback for saveCredentials (no API available)');
                const response = await fetch(`/api/credentials/${currentCredentialsService}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(credentials)
                });
                data = await response.json();
            }

            if (data && data.success) {
                showCredentialsAlert('‚úÖ Credentials succesvol opgeslagen!', 'success');
                setTimeout(() => {
                    closeCredentialsModal();
                }, 1500);
            } else {
                showCredentialsAlert(`‚ùå Fout: ${data?.error || 'Onbekende fout'}`, 'error');
            }
        } catch (error) {
            console.error('Error saving credentials:', error);
            console.error('Error details:', {
                message: error?.message,
                stack: error?.stack,
                name: error?.name,
                api: window.appApi,
                pywebview: typeof window.pywebview !== 'undefined' ? window.pywebview : 'undefined'
            });
            // Extract een duidelijke error message
            let errorMsg = 'Onbekende fout';
            if (error?.message) {
                errorMsg = error.message;
                // Als de error "save_credentials" bevat, geef een duidelijke uitleg
                if (errorMsg.includes('save_credentials') || errorMsg.includes('saveCredentials')) {
                    errorMsg = 'API methode niet beschikbaar. Probeer de applicatie opnieuw te starten.';
                }
            } else if (error?.toString) {
                errorMsg = error.toString();
            }
            showCredentialsAlert(`‚ùå Fout: ${errorMsg}`, 'error');
        }
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    window.onclick = function(event) {
        const modal = document.getElementById('credentialsModal');
        if (event.target === modal) {
            closeCredentialsModal();
        }
    }
</script>
{% endblock %}
