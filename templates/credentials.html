{% extends "base.html" %}

{% block title %}Credentials Beheer{% endblock %}

{% block content %}
<div class="section">
    <h2>üîê Credentials Beheer</h2>
    <p style="color: #666; margin-bottom: 20px;">Beheer je inloggegevens voor alle services. Klik op een service om credentials in te voeren of te bewerken.</p>
    <div class="buttons-grid">
        <button class="btn btn-add" onclick="openCredentialsModal('smartschool')">
            ‚öôÔ∏è Smartschool
        </button>
        <button class="btn btn-add" onclick="openCredentialsModal('microsoft_admin')">
            ‚öôÔ∏è Microsoft Admin
        </button>
        <button class="btn btn-add" onclick="openCredentialsModal('google_admin')">
            ‚öôÔ∏è Google Admin
        </button>
        <button class="btn btn-add" onclick="openCredentialsModal('easy4u')">
            ‚öôÔ∏è Easy4U
        </button>
    </div>
</div>
{% endblock %}

{% block modals %}
<div id="credentialsModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="credentials-modal-title">Credentials</h3>
            <span class="close" onclick="closeCredentialsModal()">&times;</span>
        </div>
        <div id="credentials-alert-container"></div>
        <form id="credentials-form" onsubmit="saveCredentials(event)">
            <div id="credentials-form-content">
                <!-- Dynamisch ingevuld -->
            </div>
            <button type="submit" class="btn btn-add" style="width: 100%;">
                üíæ Opslaan
            </button>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    const credentialsConfig = {
        smartschool: {
            title: 'Smartschool Credentials',
            fields: [
                { id: 'email', label: 'E-mail', type: 'email', required: true, placeholder: 'bijv. gebruiker@example.com' },
                { id: 'password', label: 'Wachtwoord', type: 'password', required: true, placeholder: 'Je wachtwoord' }
            ]
        },
        microsoft_admin: {
            title: 'Microsoft Admin Credentials',
            fields: [
                { id: 'url', label: 'URL', type: 'text', required: true, default: 'https://admin.microsoft.com', placeholder: 'https://admin.microsoft.com' },
                { id: 'email', label: 'E-mail', type: 'email', required: true, placeholder: 'bijv. admin@example.com' },
                { id: 'password', label: 'Wachtwoord', type: 'password', required: true, placeholder: 'Je wachtwoord' }
            ]
        },
        google_admin: {
            title: 'Google Admin Credentials',
            fields: [
                { id: 'url', label: 'URL', type: 'text', required: true, default: 'https://admin.google.com', placeholder: 'https://admin.google.com' },
                { id: 'email', label: 'E-mail', type: 'email', required: true, placeholder: 'bijv. admin@example.com' },
                { id: 'password', label: 'Wachtwoord', type: 'password', required: true, placeholder: 'Je wachtwoord' }
            ]
        },
        easy4u: {
            title: 'Easy4U Credentials',
            fields: [
                { id: 'url', label: 'URL', type: 'text', required: true, default: 'https://my.easy4u.be/nl/login', placeholder: 'https://my.easy4u.be/nl/login' },
                { id: 'email', label: 'E-mail', type: 'email', required: true, placeholder: 'bijv. gebruiker@example.com' },
                { id: 'password', label: 'Wachtwoord', type: 'password', required: true, placeholder: 'Je wachtwoord' }
            ]
        }
    };

    let currentCredentialsService = null;

    function showCredentialsAlert(message, type) {
        const container = document.getElementById('credentials-alert-container');
        container.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
        const alert = container.querySelector('.alert');
        alert.style.display = 'block';
        setTimeout(() => {
            alert.style.display = 'none';
        }, 5000);
    }

    async function openCredentialsModal(service) {
        currentCredentialsService = service;
        const config = credentialsConfig[service];
        if (!config) return;

        document.getElementById('credentials-modal-title').textContent = config.title;
        const formContent = document.getElementById('credentials-form-content');
        
        let existingCreds = {};
        try {
            const data = await window.appApi.getCredentials();
            if (data.success && data.credentials[service]) {
                existingCreds = data.credentials[service];
            }
        } catch (error) {
            console.error('Fout bij laden credentials:', error);
        }

        formContent.innerHTML = config.fields.map(field => `
            <div class="form-group">
                <label for="cred-${field.id}">${field.label}${field.required ? ' *' : ''}:</label>
                <input 
                    type="${field.type}" 
                    id="cred-${field.id}" 
                    name="${field.id}"
                    value="${escapeHtml(existingCreds[field.id] || field.default || '')}"
                    placeholder="${escapeHtml(field.placeholder || '')}"
                    ${field.required ? 'required' : ''}
                >
            </div>
        `).join('');

        document.getElementById('credentialsModal').style.display = 'block';
        document.getElementById('credentials-alert-container').innerHTML = '';
    }

    function closeCredentialsModal() {
        document.getElementById('credentialsModal').style.display = 'none';
        document.getElementById('credentials-form').reset();
        currentCredentialsService = null;
    }

    async function saveCredentials(event) {
        event.preventDefault();
        if (!currentCredentialsService) return;

        const formData = new FormData(event.target);
        const credentials = {};
        
        credentialsConfig[currentCredentialsService].fields.forEach(field => {
            const value = formData.get(field.id);
            if (value) {
                credentials[field.id] = value.trim();
            }
        });

        try {
            const data = await window.appApi.saveCredentials(currentCredentialsService, credentials);

            if (data.success) {
                showCredentialsAlert('‚úÖ Credentials succesvol opgeslagen!', 'success');
                setTimeout(() => {
                    closeCredentialsModal();
                }, 1500);
            } else {
                showCredentialsAlert(`‚ùå Fout: ${data.error}`, 'error');
            }
        } catch (error) {
            showCredentialsAlert(`‚ùå Fout: ${error.message}`, 'error');
        }
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    window.onclick = function(event) {
        const modal = document.getElementById('credentialsModal');
        if (event.target === modal) {
            closeCredentialsModal();
        }
    }
</script>
{% endblock %}
